<%- include('partials/header') %>

<!-- Top Bar -->
<div class="top-bar">
  <div>
    <h1>Search Students</h1>
    <p class="subtitle">Search across all schools, programs, and divisions</p>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <span class="status-badge active">GLOBAL SEARCH</span>
  </div>
</div>

<!-- Search Section -->
<div style="padding:24px 32px 0">
  <div class="filter-box">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
      <svg width="18" height="18" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <span style="font-size:13px;font-weight:600;color:#475569">Find Students</span>
    </div>
    <div style="display:flex;gap:16px;align-items:end">
      <div style="flex:1">
        <div class="filter-label">Search by Name, Email, Roll No, Enrollment No, or Mobile</div>
        <div style="position:relative">
          <svg width="18" height="18" fill="none" stroke="#94a3b8" stroke-width="2" viewBox="0 0 24 24" style="position:absolute;left:14px;top:50%;transform:translateY(-50%)"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input type="text" id="searchInput" placeholder="Type at least 2 characters to search..." autofocus
            style="width:100%;background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:12px 14px 12px 44px;font-size:14px;color:#0f172a;outline:none;transition:all .2s"
            onfocus="this.style.borderColor='#10b981';this.style.boxShadow='0 0 0 3px rgba(16,185,129,.12)'"
            onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
        </div>
      </div>
      <button onclick="clearSearch()" class="clear-btn" style="margin-bottom:0">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:-2px;margin-right:4px"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        Clear
      </button>
    </div>
  </div>
</div>

<!-- Results Info -->
<div style="padding:16px 32px 0;display:flex;align-items:center;justify-content:space-between" id="resultsBar" class="fade-up">
  <div style="display:flex;align-items:center;gap:8px">
    <span style="font-size:13px;color:#475569;font-weight:500" id="resultsInfo">Type to start searching</span>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
  </div>
</div>

<!-- Results -->
<div style="padding:12px 32px 40px">
  <!-- Initial State -->
  <div id="initialState">
    <div class="empty-state">
      <div class="empty-state-icon">
        <svg width="28" height="28" fill="none" stroke="#cbd5e1" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </div>
      <p style="color:#94a3b8;font-size:14px;font-weight:500;margin-bottom:4px">Search for students</p>
      <p style="color:#cbd5e1;font-size:12px">Enter a name, email, roll number, enrollment number, or mobile number</p>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingState" style="display:none;text-align:center;padding:80px 0">
    <div style="width:36px;height:36px;border:3px solid #e2e8f0;border-top-color:#10b981;border-radius:50%;margin:0 auto 12px;animation:spin .8s linear infinite"></div>
    <p style="color:#94a3b8;font-size:13px">Searching...</p>
    <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
  </div>

  <!-- No Results -->
  <div id="noResults" style="display:none">
    <div class="empty-state">
      <div class="empty-state-icon">
        <svg width="28" height="28" fill="none" stroke="#cbd5e1" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
      </div>
      <p style="color:#94a3b8;font-size:14px;font-weight:500;margin-bottom:4px">No students found</p>
      <p style="color:#cbd5e1;font-size:12px" id="noResultsText">Try a different search term</p>
    </div>
  </div>

  <!-- Results Table -->
  <div id="resultsTable" style="display:none;background:#fff;border:1px solid #e2e8f0;border-radius:14px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04)">
    <div style="overflow-x:auto">
      <table class="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Roll No</th>
            <th>Enrollment</th>
            <th>Student Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Division</th>
            <th>Program</th>
            <th>School</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.getElementById('nav-search').classList.add('active');

let searchResults = [];
let debounceTimer = null;
let acYearId = 9;

// Init: get academic year
async function init() {
  try {
    const r = await fetch('/api/filters/academic-years');
    const d = await r.json();
    if (d.success && d.data.length) acYearId = d.data[d.data.length - 1].academic_year_id;
  } catch (e) {}

  // Check URL for pre-filled search
  const p = new URLSearchParams(location.search);
  const q = p.get('q');
  if (q) {
    document.getElementById('searchInput').value = q;
    doSearch(q);
  }
}

// Debounced search on input
document.getElementById('searchInput').addEventListener('input', function () {
  clearTimeout(debounceTimer);
  const q = this.value.trim();
  if (q.length < 2) {
    showState('initial');
    document.getElementById('resultsInfo').textContent = 'Type to start searching';
    searchResults = [];
    return;
  }
  debounceTimer = setTimeout(() => doSearch(q), 350);
});

// Also search on Enter
document.getElementById('searchInput').addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    clearTimeout(debounceTimer);
    const q = this.value.trim();
    if (q.length >= 2) doSearch(q);
  }
});

async function doSearch(q) {
  showState('loading');
  try {
    const r = await fetch('/api/search/students?q=' + encodeURIComponent(q) + '&academic_year_id=' + acYearId);
    const d = await r.json();
    if (!d.success) throw new Error(d.message);
    searchResults = d.data;
    if (!searchResults.length) {
      document.getElementById('noResultsText').textContent = 'No results for "' + q + '"';
      showState('noResults');
      document.getElementById('resultsInfo').textContent = '0 results';
      } else {
      renderResults(searchResults, q);
      showState('results');
      document.getElementById('resultsInfo').innerHTML = '<span class="status-badge active" style="font-size:10px">' + searchResults.length + ' student(s) found</span>';
    }
  } catch (e) {
    document.getElementById('noResultsText').textContent = 'Error: ' + e.message;
    showState('noResults');
    document.getElementById('resultsInfo').textContent = 'Search failed';
  }
}

function showState(state) {
  document.getElementById('initialState').style.display = state === 'initial' ? 'block' : 'none';
  document.getElementById('loadingState').style.display = state === 'loading' ? 'block' : 'none';
  document.getElementById('noResults').style.display = state === 'noResults' ? 'block' : 'none';
  document.getElementById('resultsTable').style.display = state === 'results' ? 'block' : 'none';
}

function highlight(text, query) {
  if (!text || !query) return text || '-';
  const str = String(text);
  const idx = str.toLowerCase().indexOf(query.toLowerCase());
  if (idx === -1) return str;
  return str.substring(0, idx) + '<mark style="background:#d1fae5;color:#059669;padding:0 2px;border-radius:3px;font-weight:600">' + str.substring(idx, idx + query.length) + '</mark>' + str.substring(idx + query.length);
}

function renderResults(students, query) {
  const tb = document.getElementById('tb');
  tb.innerHTML = students.map((x, i) =>
    '<tr class="fade-up" style="animation-delay:' + Math.min(i * 20, 400) + 'ms">' +
    '<td style="color:#94a3b8;font-size:12px;font-weight:500">' + (i + 1) + '</td>' +
    '<td style="font-family:\'SF Mono\',monospace;font-size:12px;color:#64748b">' + highlight(x.student_roll_number, query) + '</td>' +
    '<td style="font-family:\'SF Mono\',monospace;font-size:12px;color:#64748b">' + highlight(x.student_enrollment_number, query) + '</td>' +
    '<td style="color:#0f172a;font-weight:500">' + highlight(x.student_name, query) + '</td>' +
    '<td style="color:#64748b;font-size:12px">' + highlight(x.student_email, query) + '</td>' +
    '<td style="color:#64748b;font-size:12px">' + highlight(x.student_mobile, query) + '</td>' +
    '<td><span style="font-size:10px;font-weight:600;padding:4px 10px;border-radius:6px;background:#f1f5f9;border:1px solid #e2e8f0;color:#64748b">' + (x.st_class_name || '-') + '</span></td>' +
    '<td style="font-size:12px;color:#64748b">' + (x.program_name || '-') + '</td>' +
    '<td style="font-size:12px;color:#64748b">' + (x.school_name || '-') + '</td>' +
    '</tr>'
  ).join('');
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchResults = [];
  showState('initial');
  document.getElementById('resultsInfo').textContent = 'Type to start searching';
  document.getElementById('expBtn').style.display = 'none';
  document.getElementById('searchInput').focus();
}


init();
</script>
<%- include('partials/footer') %>
