<%- include('partials/header') %>

<!-- Top Bar -->
<div class="top-bar">
  <div>
    <h1>Dashboard</h1>
    <p class="subtitle">Overview of student statistics and metrics</p>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <span class="status-badge active">LIVE</span>
  </div>
</div>

<!-- Stats Row -->
<div style="padding:24px 32px 0">
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
    <!-- Total Students -->
    <div class="stat-card">
      <div class="stat-accent" style="background:#10b981"></div>
      <div class="stat-icon" style="background:#ecfdf5">
        <svg width="22" height="22" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
      </div>
      <div class="stat-value" id="totalStudents" style="color:#10b981">-</div>
      <div class="stat-label">Total Students</div>
    </div>
    <!-- Schools -->
    <div class="stat-card">
      <div class="stat-accent" style="background:#3b82f6"></div>
      <div class="stat-icon" style="background:#eff6ff">
        <svg width="22" height="22" fill="none" stroke="#3b82f6" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
      </div>
      <div class="stat-value" id="totalSchools" style="color:#3b82f6">-</div>
      <div class="stat-label">Schools</div>
    </div>
    <!-- Programs -->
    <div class="stat-card">
      <div class="stat-accent" style="background:#8b5cf6"></div>
      <div class="stat-icon" style="background:#f5f3ff">
        <svg width="22" height="22" fill="none" stroke="#8b5cf6" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
      </div>
      <div class="stat-value" id="totalPrograms" style="color:#8b5cf6">-</div>
      <div class="stat-label">Programs</div>
    </div>
    <!-- Graduation Years -->
    <div class="stat-card">
      <div class="stat-accent" style="background:#f59e0b"></div>
      <div class="stat-icon" style="background:#fffbeb">
        <svg width="22" height="22" fill="none" stroke="#f59e0b" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
      </div>
      <div class="stat-value" id="totalGradYears" style="color:#f59e0b">-</div>
      <div class="stat-label">Graduation Years</div>
    </div>
  </div>
</div>

<!-- Filters -->
<div style="padding:20px 32px 0">
  <div class="filter-box">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
      <svg width="16" height="16" fill="none" stroke="#64748b" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
      <span style="font-size:13px;font-weight:600;color:#475569">Filters</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:16px;align-items:end">
      <div>
        <div class="filter-label">School</div>
        <select id="fSchool" onchange="onFilterChange()" class="f-select"><option value="">All Schools</option></select>
      </div>
      <div>
        <div class="filter-label">Degree</div>
        <select id="fDegree" onchange="onFilterChange()" class="f-select"><option value="">All Degrees</option></select>
      </div>
      <div>
        <div class="filter-label">Program</div>
        <select id="fProgram" onchange="onFilterChange()" class="f-select"><option value="">All Programs</option></select>
      </div>
      <div>
        <div class="filter-label">Graduation Year</div>
        <div style="position:relative">
          <button onclick="toggleGrad()" id="gradBtn" class="f-select" type="button" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;text-align:left">
            <span id="gradLabel" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">All Years</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2.5" style="flex-shrink:0;margin-left:4px"><path d="m6 9 6 6 6-6"/></svg>
          </button>
          <div id="gradDD" class="grad-dd" style="display:none;position:absolute;z-index:50;margin-top:4px;width:100%">
            <div style="max-height:200px;overflow-y:auto;padding:8px" id="gradOpts"></div>
            <div style="border-top:1px solid #e5e7eb;padding:8px;display:flex;gap:8px">
              <button onclick="selAllGrad()" style="flex:1;font-size:11px;color:#10b981;font-weight:600;background:none;border:none;cursor:pointer;padding:4px">All</button>
              <button onclick="clrGrad()" style="flex:1;font-size:11px;color:#94a3b8;font-weight:600;background:none;border:none;cursor:pointer;padding:4px">Clear</button>
            </div>
          </div>
        </div>
      </div>
      <div><button onclick="resetFilters()" class="clear-btn">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:-2px;margin-right:4px"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        Clear
      </button></div>
    </div>
    <input type="hidden" id="fAcYear" value="">
  </div>
</div>

<!-- Breadcrumb -->
<div style="padding:20px 32px 0;display:flex;align-items:center;justify-content:space-between">
  <div id="breadcrumb" class="breadcrumb">
    <span class="breadcrumb-item" style="color:#10b981;font-weight:600">Schools</span>
  </div>
  <span style="font-size:12px;color:#94a3b8;font-weight:500" id="resultCount"></span>
</div>

<!-- Cards Grid -->
<div style="padding:12px 32px 40px">
  <div id="schoolsGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px"></div>
  <div id="programsGrid" style="display:none;grid-template-columns:repeat(3,1fr);gap:16px"></div>
  <div id="cohortsGrid" style="display:none;grid-template-columns:repeat(3,1fr);gap:16px"></div>
  <div id="classesGrid" style="display:none;grid-template-columns:repeat(3,1fr);gap:16px"></div>
</div>

<script>
const C=[
  {border:'#10b981',bg:'#ecfdf5',text:'#059669'},
  {border:'#3b82f6',bg:'#eff6ff',text:'#2563eb'},
  {border:'#8b5cf6',bg:'#f5f3ff',text:'#7c3aed'},
  {border:'#f59e0b',bg:'#fffbeb',text:'#d97706'},
  {border:'#ec4899',bg:'#fdf2f8',text:'#db2777'},
  {border:'#06b6d4',bg:'#ecfeff',text:'#0891b2'},
];
const gc=i=>C[i%C.length];
let S={level:'schools',curSchool:null,curProg:null,curCohort:null};

function bq(){
  const p=new URLSearchParams(),sc=document.getElementById('fSchool').value,dg=document.getElementById('fDegree').value,pr=document.getElementById('fProgram').value,ay=document.getElementById('fAcYear').value;
  if(ay)p.set('academic_year_id',ay);if(sc)p.set('school_id',sc);if(dg)p.set('degree_id',dg);if(pr)p.set('program_abbr_id',pr);
  const g=[...document.querySelectorAll('.gc:checked')].map(c=>c.value);if(g.length)p.set('graduation_year_ids',g.join(','));
  return p.toString();
}
async function api(u){const s=u.includes('?')?'&':'?';const r=await fetch('/api/'+u+s+bq());const d=await r.json();if(!d.success)throw new Error(d.message);return d.data;}
const E=encodeURIComponent,D=decodeURIComponent;

async function init(){
  document.getElementById('nav-dashboard').classList.add('active');
  const[ac,gr,sc,dg,pr]=await Promise.all([api('filters/academic-years'),api('filters/graduation-years'),api('filters/schools'),api('filters/degrees'),api('filters/programs')]);
  if(ac.length)document.getElementById('fAcYear').value=ac[ac.length-1].academic_year_id;
  document.getElementById('gradOpts').innerHTML=gr.map(y=>`<label style="display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:background .15s" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'"><input type="checkbox" value="${y.graduation_year_id}" class="gc" style="width:16px;height:16px;accent-color:#10b981;border-radius:4px" onchange="onGradChg()"><span style="font-size:13px;color:#475569;font-weight:500">${y.graduation_year_name}</span></label>`).join('');
  selAllGrad();
  document.getElementById('fSchool').innerHTML='<option value="">All Schools</option>'+sc.map(s=>`<option value="${s.school_id}">${s.school_name}</option>`).join('');
  document.getElementById('fDegree').innerHTML='<option value="">All Degrees</option>'+dg.map(d=>`<option value="${d.certification_id}">${d.certification_name}${d.certification_short_name?' ('+d.certification_short_name+')':''}</option>`).join('');
  document.getElementById('fProgram').innerHTML='<option value="">All Programs</option>'+pr.map(p=>`<option value="${p.id}">${p.abbrivation}</option>`).join('');
  document.getElementById('totalSchools').textContent=sc.length;
  document.getElementById('totalPrograms').textContent=pr.length;
  document.getElementById('totalGradYears').textContent=gr.length;
  loadSummary();loadSchools();
}

function toggleGrad(){const d=document.getElementById('gradDD');d.style.display=d.style.display==='none'?'block':'none';}
document.addEventListener('click',e=>{if(!e.target.closest('#gradBtn')&&!e.target.closest('#gradDD'))document.getElementById('gradDD').style.display='none';});
function selAllGrad(){document.querySelectorAll('.gc').forEach(c=>c.checked=true);onGradChg();}
function clrGrad(){document.querySelectorAll('.gc').forEach(c=>c.checked=false);onGradChg();}
function onGradChg(){const ck=[...document.querySelectorAll('.gc:checked')],t=document.querySelectorAll('.gc').length;document.getElementById('gradLabel').textContent=ck.length===0?'None':ck.length===t?'All Years':ck.length+' Selected';onFilterChange();}
function onFilterChange(){showLevel('schools');loadSummary();loadSchools();}
function resetFilters(){selAllGrad();document.getElementById('fSchool').value='';document.getElementById('fDegree').value='';document.getElementById('fProgram').value='';onFilterChange();}
async function loadSummary(){try{const s=await api('summary');document.getElementById('totalStudents').textContent=(s.total_students||0).toLocaleString();}catch(e){}}

function showLevel(lv){
  S.level=lv;
  ['schoolsGrid','programsGrid','cohortsGrid','classesGrid'].forEach(id=>{const el=document.getElementById(id);el.style.display='none';el.innerHTML='';});
  document.getElementById(lv+'Grid').style.display='grid';
  updateBC();
}
function chevHTML(){return'<span class="breadcrumb-sep"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2.5"><path d="m9 5 7 7-7 7"/></svg></span>';}
function updateBC(){
  const b=document.getElementById('breadcrumb');
  let h=`<span class="breadcrumb-item" style="color:${S.level==='schools'?'#10b981':'#10b981aa'};font-weight:600" onclick="showLevel('schools');loadSchools()">Schools</span>`;
  if(['programs','cohorts','classes'].includes(S.level))h+=chevHTML()+`<span class="breadcrumb-item" style="color:${S.level==='programs'?'#0f172a':'#10b981aa'}" onclick="loadPrograms(${S.curSchool.id},'${E(S.curSchool.name)}')">${S.curSchool.name}</span>`;
  if(['cohorts','classes'].includes(S.level))h+=chevHTML()+`<span class="breadcrumb-item" style="color:${S.level==='cohorts'?'#0f172a':'#10b981aa'}" onclick="loadCohorts(${S.curSchool.id},${S.curProg.id},'${E(S.curProg.name)}')">${S.curProg.name}</span>`;
  if(S.level==='classes')h+=chevHTML()+`<span class="breadcrumb-item" style="color:#0f172a;font-weight:600">${S.curCohort.name}</span>`;
  b.innerHTML=h;
}

function mkCard(name,cnt,label,sub,click,i){
  const c=gc(i);
  return`<div class="s-card fade-up" onclick="${click}" style="border-left-color:${c.border};animation-delay:${i*60}ms">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px">
      <div class="icon-box" style="background:${c.bg};color:${c.text}">${label||'<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>'}</div>
      <span class="cnt-badge" style="background:${c.bg};color:${c.text}">${cnt.toLocaleString()} students</span>
    </div>
    <div style="font-size:15px;font-weight:600;color:#0f172a;margin-bottom:4px;line-height:1.4">${name}</div>
    <div style="font-size:12px;color:#94a3b8;display:flex;align-items:center;gap:4px">${sub} <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></div>
  </div>`;
}

const loader='<div style="grid-column:1/-1;text-align:center;padding:80px 0"><div style="width:36px;height:36px;border:3px solid #e2e8f0;border-top-color:#10b981;border-radius:50%;margin:0 auto 12px;animation:spin .8s linear infinite"></div><p style="color:#94a3b8;font-size:13px">Loading data...</p></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
const empty=m=>'<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon"><svg width="28" height="28" fill="none" stroke="#cbd5e1" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg></div><p>'+m+'</p></div>';

async function loadSchools(){const g=document.getElementById('schoolsGrid');g.innerHTML=loader;showLevel('schools');try{const d=await api('schools');document.getElementById('resultCount').textContent=d.length+' school(s)';if(!d.length){g.innerHTML=empty('No schools found');return;}g.innerHTML=d.map((s,i)=>mkCard(s.school_name,s.cnt,'','View programs',`loadPrograms(${s.school_id},'${E(s.school_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
async function loadPrograms(sid,sn){sn=D(sn);S.curSchool={id:sid,name:sn};const g=document.getElementById('programsGrid');g.innerHTML=loader;showLevel('programs');try{const d=await api('programs/'+sid);document.getElementById('resultCount').textContent=d.length+' program(s)';if(!d.length){g.innerHTML=empty('No programs');return;}g.innerHTML=d.map((p,i)=>mkCard(p.program_name,p.cnt,p.program_code||'P','View cohorts',`loadCohorts(${sid},${p.program_id},'${E(p.program_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
async function loadCohorts(sid,pid,pn){pn=D(pn);S.curProg={id:pid,name:pn};const g=document.getElementById('cohortsGrid');g.innerHTML=loader;showLevel('cohorts');try{const d=await api('cohorts/'+sid+'/'+pid);document.getElementById('resultCount').textContent=d.length+' cohort(s)';if(!d.length){g.innerHTML=empty('No cohorts');return;}g.innerHTML=d.map((c,i)=>mkCard(c.cluster_name,c.cnt,c.cluster_code||'C',(c.graduation_year_name?'Grad: '+c.graduation_year_name+' Â· ':'')+'View divisions',`loadClasses(${c.cluster_id},'${E(c.cluster_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
async function loadClasses(cid,cn){cn=D(cn);S.curCohort={id:cid,name:cn};const g=document.getElementById('classesGrid');g.innerHTML=loader;showLevel('classes');try{const d=await api('classes/'+cid);document.getElementById('resultCount').textContent=d.length+' division(s)';if(!d.length){g.innerHTML=empty('No divisions');return;}g.innerHTML=d.map((cl,i)=>mkCard(cl.st_class_name,cl.cnt,cl.st_class_code||'D','View students',`goStudents(${cl.st_class_id},'${E(cl.st_class_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
function goStudents(cid,cn){window.location.href='/students?class_id='+cid+'&class_name='+cn+'&school='+E(S.curSchool.name)+'&program='+E(S.curProg.name)+'&cohort='+E(S.curCohort.name)+'&'+bq();}
init();
</script>
<%- include('partials/footer') %>
