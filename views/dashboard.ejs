<%- include('partials/header') %>

<!-- Top bar - white like ATLAS -->
<div style="background:#fff;border-bottom:1px solid #e5e7eb;padding:20px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:20">
  <div>
    <h1 style="font-size:22px;font-weight:700;color:#1e293b;margin:0">Dashboard</h1>
    <p style="font-size:13px;color:#94a3b8;margin:4px 0 0">Overview of student statistics and metrics</p>
  </div>
  <div style="text-align:right">
    <p style="font-size:28px;font-weight:700;color:#10b981;margin:0;line-height:1" id="totalStudents">-</p>
    <p style="font-size:10px;color:#94a3b8;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin:4px 0 0">Students</p>
  </div>
</div>

<!-- Filters -->
<div style="padding:24px 32px 0">
  <div class="filter-box">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:16px;align-items:end">
      <div>
        <div class="filter-label">School</div>
        <select id="fSchool" onchange="onFilterChange()" class="f-select"><option value="">All Schools</option></select>
      </div>
      <div>
        <div class="filter-label">Degree</div>
        <select id="fDegree" onchange="onFilterChange()" class="f-select"><option value="">All Degrees</option></select>
      </div>
      <div>
        <div class="filter-label">Program</div>
        <select id="fProgram" onchange="onFilterChange()" class="f-select"><option value="">All Programs</option></select>
      </div>
      <div>
        <div class="filter-label">Graduation Year</div>
        <div style="position:relative">
          <button onclick="toggleGrad()" id="gradBtn" class="f-select" type="button" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;text-align:left">
            <span id="gradLabel" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">All Years</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2.5" style="flex-shrink:0;margin-left:4px"><path d="m6 9 6 6 6-6"/></svg>
          </button>
          <div id="gradDD" class="grad-dd" style="display:none;position:absolute;z-index:50;margin-top:4px;width:100%">
            <div style="max-height:200px;overflow-y:auto;padding:8px" id="gradOpts"></div>
            <div style="border-top:1px solid #e5e7eb;padding:8px;display:flex;gap:8px">
              <button onclick="selAllGrad()" style="flex:1;font-size:11px;color:#10b981;font-weight:600;background:none;border:none;cursor:pointer;padding:4px">All</button>
              <button onclick="clrGrad()" style="flex:1;font-size:11px;color:#94a3b8;font-weight:600;background:none;border:none;cursor:pointer;padding:4px">Clear</button>
            </div>
          </div>
        </div>
      </div>
      <div><button onclick="resetFilters()" class="clear-btn">Clear</button></div>
    </div>
    <input type="hidden" id="fAcYear" value="">
  </div>
</div>

<!-- Breadcrumb -->
<div style="padding:20px 32px 0;display:flex;align-items:center;justify-content:space-between">
  <div id="breadcrumb" style="display:flex;align-items:center;gap:6px">
    <span style="font-size:14px;font-weight:600;color:#10b981">Schools</span>
  </div>
  <span style="font-size:12px;color:#94a3b8" id="resultCount"></span>
</div>

<!-- Cards Grid -->
<div style="padding:12px 32px 40px">
  <div id="schoolsGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px"></div>
  <div id="programsGrid" style="display:none;grid-template-columns:repeat(3,1fr);gap:16px"></div>
  <div id="cohortsGrid" style="display:none;grid-template-columns:repeat(3,1fr);gap:16px"></div>
  <div id="classesGrid" style="display:none;grid-template-columns:repeat(3,1fr);gap:16px"></div>
</div>

<script>
const C=[
  {border:'#10b981',bg:'#ecfdf5',text:'#059669'},
  {border:'#06b6d4',bg:'#ecfeff',text:'#0891b2'},
  {border:'#8b5cf6',bg:'#f5f3ff',text:'#7c3aed'},
  {border:'#f59e0b',bg:'#fffbeb',text:'#d97706'},
  {border:'#ec4899',bg:'#fdf2f8',text:'#db2777'},
  {border:'#ef4444',bg:'#fef2f2',text:'#dc2626'},
];
const gc=i=>C[i%C.length];
let S={level:'schools',curSchool:null,curProg:null,curCohort:null};

function bq(){
  const p=new URLSearchParams(),sc=document.getElementById('fSchool').value,dg=document.getElementById('fDegree').value,pr=document.getElementById('fProgram').value,ay=document.getElementById('fAcYear').value;
  if(ay)p.set('academic_year_id',ay);if(sc)p.set('school_id',sc);if(dg)p.set('degree_id',dg);if(pr)p.set('program_abbr_id',pr);
  const g=[...document.querySelectorAll('.gc:checked')].map(c=>c.value);if(g.length)p.set('graduation_year_ids',g.join(','));
  return p.toString();
}
async function api(u){const s=u.includes('?')?'&':'?';const r=await fetch('/api/'+u+s+bq());const d=await r.json();if(!d.success)throw new Error(d.message);return d.data;}
const E=encodeURIComponent,D=decodeURIComponent;

async function init(){
  document.getElementById('nav-dashboard').classList.add('active');
  const[ac,gr,sc,dg,pr]=await Promise.all([api('filters/academic-years'),api('filters/graduation-years'),api('filters/schools'),api('filters/degrees'),api('filters/programs')]);
  if(ac.length)document.getElementById('fAcYear').value=ac[ac.length-1].academic_year_id;
  document.getElementById('gradOpts').innerHTML=gr.map(y=>`<label style="display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:6px;cursor:pointer" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'"><input type="checkbox" value="${y.graduation_year_id}" class="gc" style="width:15px;height:15px;accent-color:#10b981" onchange="onGradChg()"><span style="font-size:13px;color:#475569">${y.graduation_year_name}</span></label>`).join('');
  selAllGrad();
  document.getElementById('fSchool').innerHTML='<option value="">All Schools</option>'+sc.map(s=>`<option value="${s.school_id}">${s.school_name}</option>`).join('');
  document.getElementById('fDegree').innerHTML='<option value="">All Degrees</option>'+dg.map(d=>`<option value="${d.certification_id}">${d.certification_name}${d.certification_short_name?' ('+d.certification_short_name+')':''}</option>`).join('');
  document.getElementById('fProgram').innerHTML='<option value="">All Programs</option>'+pr.map(p=>`<option value="${p.id}">${p.abbrivation}</option>`).join('');
  loadSummary();loadSchools();
}

function toggleGrad(){const d=document.getElementById('gradDD');d.style.display=d.style.display==='none'?'block':'none';}
document.addEventListener('click',e=>{if(!e.target.closest('#gradBtn')&&!e.target.closest('#gradDD'))document.getElementById('gradDD').style.display='none';});
function selAllGrad(){document.querySelectorAll('.gc').forEach(c=>c.checked=true);onGradChg();}
function clrGrad(){document.querySelectorAll('.gc').forEach(c=>c.checked=false);onGradChg();}
function onGradChg(){const ck=[...document.querySelectorAll('.gc:checked')],t=document.querySelectorAll('.gc').length;document.getElementById('gradLabel').textContent=ck.length===0?'None':ck.length===t?'All Years':ck.length+' Selected';onFilterChange();}
function onFilterChange(){showLevel('schools');loadSummary();loadSchools();}
function resetFilters(){selAllGrad();document.getElementById('fSchool').value='';document.getElementById('fDegree').value='';document.getElementById('fProgram').value='';onFilterChange();}
async function loadSummary(){try{const s=await api('summary');document.getElementById('totalStudents').textContent=(s.total_students||0).toLocaleString();}catch(e){}}

function showLevel(lv){
  S.level=lv;
  ['schoolsGrid','programsGrid','cohortsGrid','classesGrid'].forEach(id=>{const el=document.getElementById(id);el.style.display='none';el.innerHTML='';});
  document.getElementById(lv+'Grid').style.display='grid';
  updateBC();
}
function chevHTML(){return'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2" style="margin:0 2px"><path d="m9 5 7 7-7 7"/></svg>';}
function updateBC(){
  const b=document.getElementById('breadcrumb');
  let h=`<span style="font-size:14px;font-weight:600;color:${S.level==='schools'?'#10b981':'#10b981aa'};cursor:pointer" onclick="showLevel('schools');loadSchools()">Schools</span>`;
  if(['programs','cohorts','classes'].includes(S.level))h+=chevHTML()+`<span style="font-size:14px;font-weight:500;color:${S.level==='programs'?'#1e293b':'#10b981aa'};cursor:pointer" onclick="loadPrograms(${S.curSchool.id},'${E(S.curSchool.name)}')">${S.curSchool.name}</span>`;
  if(['cohorts','classes'].includes(S.level))h+=chevHTML()+`<span style="font-size:14px;font-weight:500;color:${S.level==='cohorts'?'#1e293b':'#10b981aa'};cursor:pointer" onclick="loadCohorts(${S.curSchool.id},${S.curProg.id},'${E(S.curProg.name)}')">${S.curProg.name}</span>`;
  if(S.level==='classes')h+=chevHTML()+`<span style="font-size:14px;font-weight:500;color:#1e293b">${S.curCohort.name}</span>`;
  b.innerHTML=h;
}

const bldg='<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>';

function mkCard(name,cnt,label,sub,click,i){
  const c=gc(i);
  return`<div class="s-card fade-up" onclick="${click}" style="border-left-color:${c.border};animation-delay:${i*60}ms">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px">
      <div class="icon-box" style="background:${c.bg};color:${c.text}">${label||bldg}</div>
      <span class="cnt-badge" style="background:${c.bg};color:${c.text}">${cnt.toLocaleString()} students</span>
    </div>
    <div style="font-size:15px;font-weight:600;color:#1e293b;margin-bottom:4px;line-height:1.4">${name}</div>
    <div style="font-size:12px;color:#94a3b8">${sub}</div>
  </div>`;
}

const loader='<div style="grid-column:1/-1;text-align:center;padding:80px 0;color:#94a3b8;font-size:13px">Loading...</div>';
const empty=m=>'<div style="grid-column:1/-1;text-align:center;padding:80px 0;color:#94a3b8;font-size:13px">'+m+'</div>';

async function loadSchools(){const g=document.getElementById('schoolsGrid');g.innerHTML=loader;showLevel('schools');try{const d=await api('schools');document.getElementById('resultCount').textContent=d.length+' school(s)';if(!d.length){g.innerHTML=empty('No schools found');return;}g.innerHTML=d.map((s,i)=>mkCard(s.school_name,s.cnt,'','Click to view programs →',`loadPrograms(${s.school_id},'${E(s.school_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
async function loadPrograms(sid,sn){sn=D(sn);S.curSchool={id:sid,name:sn};const g=document.getElementById('programsGrid');g.innerHTML=loader;showLevel('programs');try{const d=await api('programs/'+sid);document.getElementById('resultCount').textContent=d.length+' program(s)';if(!d.length){g.innerHTML=empty('No programs');return;}g.innerHTML=d.map((p,i)=>mkCard(p.program_name,p.cnt,p.program_code||'P','Click to view cohorts →',`loadCohorts(${sid},${p.program_id},'${E(p.program_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
async function loadCohorts(sid,pid,pn){pn=D(pn);S.curProg={id:pid,name:pn};const g=document.getElementById('cohortsGrid');g.innerHTML=loader;showLevel('cohorts');try{const d=await api('cohorts/'+sid+'/'+pid);document.getElementById('resultCount').textContent=d.length+' cohort(s)';if(!d.length){g.innerHTML=empty('No cohorts');return;}g.innerHTML=d.map((c,i)=>mkCard(c.cluster_name,c.cnt,c.cluster_code||'C',(c.graduation_year_name?'Grad: '+c.graduation_year_name+' · ':'')+'Click for divisions →',`loadClasses(${c.cluster_id},'${E(c.cluster_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
async function loadClasses(cid,cn){cn=D(cn);S.curCohort={id:cid,name:cn};const g=document.getElementById('classesGrid');g.innerHTML=loader;showLevel('classes');try{const d=await api('classes/'+cid);document.getElementById('resultCount').textContent=d.length+' division(s)';if(!d.length){g.innerHTML=empty('No divisions');return;}g.innerHTML=d.map((cl,i)=>mkCard(cl.st_class_name,cl.cnt,cl.st_class_code||'D','View student list →',`goStudents(${cl.st_class_id},'${E(cl.st_class_name)}')`,i)).join('');}catch(e){g.innerHTML=empty('Error: '+e.message);}}
function goStudents(cid,cn){window.location.href='/students?class_id='+cid+'&class_name='+cn+'&school='+E(S.curSchool.name)+'&program='+E(S.curProg.name)+'&cohort='+E(S.curCohort.name)+'&'+bq();}
init();
</script>
<%- include('partials/footer') %>
